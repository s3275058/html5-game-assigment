/**
 * Copyright (C) 2013 Heiko Irrgang <hi@93i.de>
 * 
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use,
 * copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following
 * conditions:
 * 
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 * OTHER DEALINGS IN THE SOFTWARE.
 */
gamlib={};gamlib.AI={STRATEGY_AVOID_STEPS:0,STRATEGY_IGNORE_STEPS:1};(function(){var a=1;var b=false;gamlib.Class=function(){};gamlib.Class.prototype.objectID=function(){if(typeof this.__oid=="undefined"){this.__oid=a++}return this.__oid};gamlib.Class.extend=function(f){var d=this.prototype;b=true;var e=new this();b=false;for(var c in f){if((typeof d[c]=="function")&&(typeof f[c]=="function")){e[c]=(function(g,h){return function(){var j=this._super;this._super=d[g];var i=h.apply(this,arguments);this._super=j;return i}})(c,f[c])}else{e[c]=f[c]}}ret=function(){if((!b)&&(typeof this.create=="function")){this.create.apply(this,arguments)}};ret.prototype=e;ret.prototype.constructor=gamlib.Class;ret.extend=this.extend;return ret}})();gamlib.Vector=gamlib.Class.extend({create:function(a,c,b){(a)?this.x=a:this.x=0;(c)?this.y=c:this.y=0;(b)?this.z=b:this.z=0},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},quickLength:function(){return this.x*this.x+this.y*this.y+this.z*this.z},normalized:function(){var b=new gamlib.Vector();var a=this.length();b.x=this.x/a;b.y=this.y/a;b.z=this.z/a;return b},subtract:function(a){var b=new gamlib.Vector(this.x,this.y,this.z);b.x-=a.x;b.y-=a.y;b.z-=a.z;return b},add:function(a){var b=new gamlib.Vector(this.x,this.y,this.z);b.x+=a.x;b.y+=a.y;b.z+=a.z;return b},difference:function(a){return new gamlib.Vector(a.x-this.x,a.y-this.y,a.z-this.z)},copy:function(){return new gamlib.Vector(this.x,this.y,this.z)},distance:function(a){var b=this.difference(a);return b.length()},quickDistance:function(a){var b=this.difference(a);return b.quickLength()}});gamlib.AStarNode=gamlib.Class.extend({create:function(a,d,b,c){this.connected=new Array();this.position=new gamlib.Vector(a,d,b);(c)?this.id=c:this.id=this.position.x+"_"+this.position.y+"_"+this.position.z},g:function(a){return 1},h:function(c,b){var a=this.position.difference(b.position);return a.length()},connect:function(b,a){this.connected.push(b);if((a)||(typeof a=="undefined")){b.connect(this,false)}}});gamlib.AStarInfo=function(d,c,a,b){this.node=d;this.sw=c;this.tw=a;this.pi=b};gamlib.AStarMap=gamlib.Class.extend({create:function(a){this.nodes=new Array();this.returnFirst=true;if(typeof a!="undefined"){this.returnFirst=a}},includeFirstNode:function(a){this.returnFirst=a},add:function(a){if(a instanceof gamlib.AStarNode){this.nodes.push(a)}},find:function(g,o,e,p,a,h){var v=[];var q=null;var b=null;if((g instanceof gamlib.AStarNode)&&(o instanceof gamlib.AStarNode)){q=g;b=o}else{q=this.getNearest(g,o,e);b=this.getNearest(p,a,h);if((!(q instanceof gamlib.AStarNode))||(!(b instanceof gamlib.AStarNode))){return[]}}var k=[new gamlib.AStarInfo(q,0,0,null)];var j=[];var i=[];var l=false;var s=null;while((!l)&&(k.length)){s=k.shift();if(s.node===b){l=true;continue}for(var u=0;u<s.node.connected.length;u++){var f=s.node.connected[u];var w=f.objectID();if((!j[w])&&(!i[w])){var n=s.node.g(f);if(n<0){continue}var t=s.node.h(f,b);var r=s.sw+n+t;var d=false;for(var m=0;m<k.length&&d===false;m++){if(k[m].sw+k[m].tw>r){k.splice(m,0,new gamlib.AStarInfo(f,s.nWeight+r,t,s));j[w]=true;d=true}}if(!d){k.push(new gamlib.AStarInfo(f,s.nWeight+r,t,s));j[w]=true}}}i[s.node.objectID()]=true}if(l){while(s.pi!==null){v.unshift(s.node);s=s.pi}if(this.returnFirst){v.unshift(s.node)}}return v},getNearest:function(a,j,g){var h=null;if(a instanceof gamlib.AStarNode){h=new gamlib.AStarNode(a.position.x,a.position.y,a.position.z)}else{h=new gamlib.AStarNode(a,j,g)}var b=-1;var e=Infinity;for(var c=0;c<this.nodes.length;c++){if(this.nodes[c].id!=h.id){var f=h.position.quickDistance(this.nodes[c].position);if(f<e){e=f;b=c}}}if(b>=0){return this.nodes[b]}return null}});gamlib.AStarArrayNode=gamlib.AStarNode.extend({create:function(c,b,a,f,d,e){this._super(a,f,d,e);this.strategy=c;this.value=b},setValue:function(a){this.value=a},g:function(d){if(this.value<0){return this.value}var c=(d.position.x-this.position.x);var b=(d.position.y-this.position.y);if(this.strategy==1){if(d.value<0){return c*c+b*b}return 0}if(d.value<0){return d.value}var a=Math.abs(this.value-d.value);return c*c+b*b+a*a}});gamlib.AStarArray=gamlib.AStarMap.extend({create:function(m,d,e,j,f,c){this._super(j);if(typeof f=="undefined"){this.strategy=0}else{this.strategy=f}this.width=m;this.height=d;this.setDefault(c);if(typeof e!="undefined"){this.useDiagonal=e}else{this.useDiagonal=false}for(var k=0;k<d;k++){for(var l=0;l<m;l++){this.add(new gamlib.AStarArrayNode(this.strategy,this.defaultValue,l,k))}}for(var i=0;i<d;i++){for(var a=0;a<m;a++){var g=null;var b=this.nodes[i*m+a];if(a>0){g=this.nodes[(i)*m+(a-1)];b.connect(g,false);if(this.useDiagonal){if(i>0){g=this.nodes[(i-1)*m+(a-1)];b.connect(g,false)}if(i<d-1){g=this.nodes[(i+1)*m+(a-1)];b.connect(g,false)}}}if(i>0){g=this.nodes[(i-1)*m+(a)];b.connect(g,false)}if(i<this.height-1){g=this.nodes[(i+1)*m+(a)];b.connect(g,false)}if(a<this.width-1){g=this.nodes[(i)*m+(a+1)];b.connect(g,false);if(this.useDiagonal){if(i>0){g=this.nodes[(i-1)*m+(a+1)];b.connect(g,false)}if(i<d-1){g=this.nodes[(i+1)*m+(a+1)];b.connect(g,false)}}}}}},setDefault:function(a){if(a){this.defaultValue=a}else{this.defaultValue=0}},setValue:function(a,c,b){if((a<this.width)&&(c<this.height)){this.nodes[c*this.width+a].setValue(b)}},getValue:function(a,b){if((a<this.width)&&(b<this.height)){return this.nodes[b*this.width+a].value}return -1},find:function(b,c,d,e){if((b instanceof gamlib.AStarNode)&&(c instanceof gamlib.AStarNode)){return this._super(b,c)}if((b<this.width)&&(c<this.height)&&(d<this.width)&&(e<this.width)){var f=this.nodes[c*this.width+b];var a=this.nodes[e*this.width+d];return this._super(f,a)}}});